<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>聊天记录</title>

    <link rel="stylesheet" href="/template/pc/gongzhuwangluo/static/layim/layui/css/layui.css">
    <style>
        body .layim-chat-main {
            height: auto;
        }
    </style>
</head>
<body>

<div id="loadmoreBtn" style="text-align: center;">
    <input type="text" id="page" value="1" hidden>
    <button id="loadmore" class="layui-btn">查看更多记录</button>
</div>

<div class="layim-chat-main">
    <ul id="LAY_view"></ul>
</div>

<textarea title="消息模版" id="LAY_tpl" style="display:none;">
{{# layui.each(d.data, function(index, item){
  if(item.mine == 1){ }}
    <li class="layim-chat-mine"><div class="layim-chat-user"><img
            src="{{ item.avatar }}"><cite><i>{{ item.created_at }}</i>{{ item.username }}</cite></div><div
            class="layim-chat-text">{{ layui.layim.content(item.content) }}</div></li>
  {{# } else { }}
    <li><div class="layim-chat-user"><img src="{{ item.avatar }}"><cite>{{ item.username }}<i>{{ item.created_at }}</i></cite></div><div
            class="layim-chat-text">{{ layui.layim.content(item.content) }}</div></li>
  {{# }
}); }}
</textarea>

<script src="/template/pc/gongzhuwangluo/static/layim/layui/layui.js"></script>
<script>
    layui.use(['layim', 'laypage'], function () {
        var laytpl = layui.laytpl, $ = layui.jquery;
        var param = location.search; //获得URL参数。该窗口url会携带会话id和type，他们是你请求聊天记录的重要凭据
        var param_arr = param.split('?');
        param = '?'+param_arr[2]+'&'+param_arr[1];
        var page = $('#page').val();
        var get_msg_url = 'http://test.conzhu.com/home/webimApi/chat_log' + param + '&page=';
        //开始请求聊天记录
        $.get(get_msg_url + page, function (resData) {
            var html = laytpl(LAY_tpl.value).render({
                data: resData.data
            });
            if (resData.isEnd === 1) {
                $('#loadmoreBtn').remove();
            } else {
                $('#page').val(parseInt(resData.page) + 1);
            }
            $('#LAY_view').html(html);
            //点击[查看更多记录]后,继续查询
            $('#loadmore').click(function () {
                var page2 = $('#page').val();
                $.get(get_msg_url + page2, function (resData) {
                    if (resData.isEnd === 1) {
                        $('#loadmoreBtn').remove();
                    } else {
                        $('#page').val(parseInt(resData.page) + 1);
                    }
                    var html = laytpl(LAY_tpl.value).render({
                        data: resData.data
                    });
                    $('#LAY_view').prepend(html);
                }, 'json');
            });
        });
    });
</script>
</body>
</html>
